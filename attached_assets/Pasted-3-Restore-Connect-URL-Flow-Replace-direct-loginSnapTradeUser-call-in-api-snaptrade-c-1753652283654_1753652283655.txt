3. **Restore Connect URL Flow**  
   • Replace direct `loginSnapTradeUser` call in `/api/snaptrade/connect-url` with:  
     ```ts
     const { data } = await snapTradeClient.connections.getConnectBrokerageURL({
       snapTradeGetConnectBrokerageURLRequestBody: {
         userId, userSecret, provider: "alpaca", returnURL: `${FRONTEND_ORIGIN}/api/snaptrade/connection-portal`
       }
     });
     ```  
   • Return `data.redirectURI` as the popup URL.

4. **Implement `/api/snaptrade/connection-portal`**  
   • New POST handler that validates `code` and `state` from the redirect.  
   • Call `snapTradeClient.authentication.loginSnapTradeUser({ userId, userSecret })` to finalize authentication.  
   • On success: `res.send("<script>window.opener.postMessage('snaptrade_connected','*');window.close();</script>")`.  
   • Frontend listens for `message` event to refresh account list.

5. **Persistent Credentials & Auto-Refresh**  
   • In your Market‑Data service, always check for stored `snaptradeUserId` & `userSecret`—if missing or expired (401), automatically re‐register + re‐login and update storage.  
   • Wrap all SnapTrade calls in a try/catch: on 401, refresh credentials then retry once.

6. **Unified Market‑Data Endpoint**  
   • Consolidate to a single `/api/market-data/bulk` that uses **only SnapTrade’s referenceData or quotes endpoint** after auth.  
   • Remove Alpha Vantage and IEX fallbacks to avoid mixed sources and rate‐limit errors.  
   • Cache results for 5 seconds.

7. **End‑to‑End Verification**  
   • Test the connect button: popup opens, you log in, it redirects to `connection-portal`, popup closes, grid refreshes.  
   • Call `/api/market-data/bulk?symbols=AAPL,TSLA,GOOGL` and confirm valid prices (no 401).  
   • Verify Dashboard, Watchlist, and Stock pages show identical live prices.

Please make all changes in one PR titled  
`fix(snaptrade): correct auth signature & restore connect flow`,  
then verify the full SnapTrade connect + live‑pricing flow before marking ready.  








Sources

Ask ChatGPT
