# Flint Backend Structure Document

## Table of Contents
1. [API Endpoints](#api-endpoints)
2. [Controllers and Services](#controllers-and-services)
3. [Database Schema](#database-schema)
4. [Data Flow](#data-flow)
5. [Third-party Integrations](#third-party-integrations)
6. [State Management Logic](#state-management-logic)
7. [Error Handling](#error-handling)
8. [API Documentation](#api-documentation)

## API Endpoints

### User Management
- **POST /api/auth/register**
  - **Request:** `{"email": "string", "password": "string"}`
  - **Response:** `{"userId": "string", "email": "string"}`

- **POST /api/auth/login**
  - **Request:** `{"email": "string", "password": "string"}`
  - **Response:** `{"token": "string", "expiresIn": "number"}`

- **POST /api/auth/reset-password**
  - **Request:** `{"email": "string"}`
  - **Response:** `{"message": "string"}`

- **GET /api/users/:userId**
  - **Response:** `{"userId": "string", "name": "string", "email": "string", "accounts": "array"}`

### Account Management
- **POST /api/accounts/link**
  - **Request:** `{"provider": "string", "authCode": "string"}`
  - **Response:** `{"accountId": "string", "provider": "string", "linked": "boolean"}`

- **GET /api/accounts/:accountId**
  - **Response:** `{"accountId": "string", "balances": "object", "transactions": "array"}`

### Trading
- **POST /api/trades/execute**
  - **Request:** `{"accountId": "string", "asset": "string", "action": "buy/sell", "quantity": "number"}`
  - **Response:** `{"tradeId": "string", "status": "string", "executedAt": "date"}`

### Watchlist
- **POST /api/watchlist/add**
  - **Request:** `{"userId": "string", "asset": "string"}`
  - **Response:** `{"watchlistId": "string", "asset": "string", "addedAt": "date"}`

- **GET /api/watchlist/:userId**
  - **Response:** `{"watchlist": "array"}`

## Controllers and Services

### Controllers
- **AuthController:** Handles user authentication and authorization tasks.
- **UserController:** Manages user-related operations such as profile retrieval and updates.
- **AccountController:** Oversees account linking and information retrieval.
- **TradeController:** Manages trading operations and execution.
- **WatchlistController:** Manages user watchlists for stocks and cryptocurrencies.

### Services
- **AuthService:** Provides methods for authentication and JWT token generation.
- **UserService:** Provides user data management functions.
- **AccountService:** Connects with third-party APIs for account linking and data retrieval.
- **TradeService:** Executes trades through SnapTrade API.
- **WatchlistService:** Manages user-specific watchlist operations.

## Database Schema

### User Table
- **user_id:** UUID, Primary Key
- **email:** String, Unique
- **password_hash:** String
- **created_at:** Timestamp

### Account Table
- **account_id:** UUID, Primary Key
- **user_id:** UUID, Foreign Key
- **provider:** String
- **balances:** JSONB
- **linked_at:** Timestamp

### Trade Table
- **trade_id:** UUID, Primary Key
- **account_id:** UUID, Foreign Key
- **asset:** String
- **action:** String
- **quantity:** Integer
- **status:** String
- **executed_at:** Timestamp

### Watchlist Table
- **watchlist_id:** UUID, Primary Key
- **user_id:** UUID, Foreign Key
- **asset:** String
- **added_at:** Timestamp

## Data Flow

1. **User Registration/Login:**
   - User sends a request to the authentication endpoint.
   - AuthController calls AuthService to validate and process the request.
   - On success, a JWT token is generated and sent back to the user.

2. **Account Linking:**
   - User initiates account linking via OAuth.
   - AccountController interacts with AccountService to connect and fetch account data via APIs.
   - Account information and balances are saved to the database.

3. **Trading Execution:**
   - User sends a trade request.
   - TradeController validates the request and calls TradeService.
   - TradeService interacts with SnapTrade API to execute the trade.
   - Response is logged and returned to the user.

4. **Watchlist Management:**
   - User adds/removes assets from their watchlist.
   - WatchlistController updates the Watchlist table through WatchlistService.
   - Updated watchlist is fetched as needed.

## Third-party Integrations

- **SnapTrade API:** For brokerage and crypto account aggregation, trading execution.
- **Teller.io API:** For bank account linking and transaction history.
- **Stripe:** Payment processing for subscriptions.
- **Auth0:** Used for secure authentication and authorization flows.
- **Mixpanel & LogRocket:** For analytics and user behavior tracking.
- **Sentry:** Error tracking and monitoring.

## State Management Logic

- **Session Management:** Auth0 and JWT tokens for managing user sessions.
- **Caching Strategies:** Use Redis for caching frequently accessed data to improve performance.
- **Queue Management:** Use RabbitMQ for handling background tasks such as trade execution and notification sending.

## Error Handling

- **Error Logging:** Use Sentry for real-time error tracking and alerting.
- **Error Response:** Errors are caught in controllers, logged, and a standardized error response is returned to clients.
- **Retry Mechanisms:** Implement retry logic for failed third-party API calls.

## API Documentation

- **Format:** The API is documented using OpenAPI/Swagger.
- **Documentation Features:**
  - Interactive API explorer for testing endpoints.
  - Detailed request/response schemas.
  - Authentication and authorization details.
  - Example requests and responses for each endpoint.

This backend structure document outlines the essential components needed to build and maintain Flint's backend infrastructure, ensuring a robust and secure financial management platform.