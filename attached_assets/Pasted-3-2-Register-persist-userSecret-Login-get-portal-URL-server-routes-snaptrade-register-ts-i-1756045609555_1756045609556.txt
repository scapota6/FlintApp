3.2 Register → persist userSecret → Login (get portal URL)

// server/routes/snaptrade.register.ts
import { Router } from "express";
import { snaptrade } from "../snaptrade/client";
import { ensureUser } from "../middleware/auth";
import { db } from "../storage"; // your DB helpers

const r = Router();

/**
 * POST /api/connections/snaptrade/register
 * body: { userId?: string } // optional; otherwise take from session
 */
r.post("/api/connections/snaptrade/register", ensureUser, async (req, res) => {
  try {
    const userId = String(req.user.id); // e.g., "45137738"
    const email  = String(req.user.email);

    // 1) If we already have a userSecret, reuse it. Otherwise register.
    let creds = await db.getSnaptradeCreds(userId); // { userSecret } | null

    if (!creds?.userSecret) {
      const reg = await snaptrade.authentication.registerSnapTradeUser({
        userId,       // stable id in your system
        userEmail: email,
      });
      // Some SDKs return { userSecret }, others return { data: { userSecret } }
      const userSecret = (reg as any)?.userSecret ?? (reg as any)?.data?.userSecret;
      if (!userSecret) {
        return res.status(500).json({ message: "No userSecret from SnapTrade" });
      }
      await db.upsertSnaptradeCreds(userId, userSecret);
      creds = { userSecret };
    }

    // 2) Generate the Connection Portal URL (login)
    const login = await snaptrade.authentication.loginSnapTradeUser({
      userId,
      userSecret: creds.userSecret,
      redirectUri: process.env.SNAPTRADE_REDIRECT_URI!, // must match SnapTrade app config
      // optional: brokerage: "fidelity", "schwab", etc.
    });

    const url = (login as any)?.redirectURI ?? (login as any)?.data?.redirectURI;
    if (!url) return res.status(500).json({ message: "No redirectURI from SnapTrade" });

    return res.json({ portalUrl: url });
  } catch (e: any) {
    // Common root causes:
    // - 1076 Unable to verify signature: wrong/mismatched CONSUMER_KEY
    // - undefined loginSnapTradeUser: wrong SDK import or old version
    console.error("[SnapTrade] registration error", e?.response?.data || e);
    return res.status(500).json({ message: "Failed to register with SnapTrade" });
  }
});

export default r;
