You’ve got two separate issues again:

Disconnect = 403 (Invalid CSRF)

Credit-card details = 500 (server log earlier showed “Teller API error: 403” → stale/invalid Teller token or wrong account mapping)

Below is a focused, do-this-now plan with small code you can paste. It follows Teller + general CSRF best-practices and won’t touch your SnapTrade paths.

1) Kill the 403 on /api/banks/disconnect
A) Server: make CSRF observable + consistent
Put this before routes (once). It uses the double-submit cookie pattern and returns JSON on CSRF errors.

ts
Copy
Edit
// server/security/csrf.ts
import cookieParser from 'cookie-parser';
import csrf from 'csurf';
import type { Express, Request, Response, NextFunction } from 'express';

export function installCsrf(app: Express) {
  app.set('trust proxy', 1);
  app.use(cookieParser());
  app.use((req, _res, next) => {
    // some hosts (replit) need body parser before csurf
    if (req.headers['content-type']?.includes('application/json')) {
      // if you already call express.json() globally, remove this
    }
    next();
  });

  const isProd = process.env.NODE_ENV === 'production';
  app.use(csrf({
    cookie: {
      key: 'flint_csrf',
      path: '/',
      sameSite: isProd ? 'none' : 'lax',
      secure: isProd,
      httpOnly: false, // client must read to echo in header
    }
  }));

  app.get('/api/csrf-token', (req: Request, res: Response) => {
    res.json({ csrfToken: req.csrfToken() });
  });

  // dev-only probe to see what the server receives (remove in prod)
  app.post('/api/_debug/csrf-check', (req: Request, res: Response) => {
    const header = (req.headers['x-csrf-token'] || req.headers['csrf-token'] || '') as string;
    const cookie = (req.headers.cookie || '').includes('flint_csrf=');
    res.json({ ok: true, headerPresent: !!header, cookiePresent: cookie });
  });

  app.use((err: any, _req: Request, res: Response, next: NextFunction) => {
    if (err?.code === 'EBADCSRFTOKEN') {
      return res.status(403).json({ code: 'CSRF_INVALID', message: 'Invalid CSRF token' });
    }
    next(err);
  });
}